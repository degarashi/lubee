diff --git a/dumper.py b/dumper.py
index 104c20a..3d5473d 100644
--- a/dumper.py
+++ b/dumper.py
@@ -33,6 +33,7 @@ import time
 import json
 import inspect
 import threading
+import gdb

 if sys.version_info[0] >= 3:
     xrange = range
@@ -131,6 +132,13 @@ def arrayForms():
 def mapForms():
     return [CompactMapFormat]

+def lb_SetNative(dst, nv):
+    dst.native = nv
+    return dst
+def lb_GetArrayNative(d, ptr, typ):
+    TP = d.lookupNativeType(typ.name + "*")
+    A = gdb.Value(ptr).cast(TP)
+    return lb_SetNative(d.createValue(ptr, typ), A.dereference())

 class ReportItem:
     """
@@ -2078,7 +2086,8 @@ class DumperBase:
             with Children(self, n, innerType, childNumChild, maxNumChild,
                     addrBase=addrBase, addrStep=innerSize):
                 for i in self.childRange():
-                    self.putSubItem(i, self.createValue(addrBase + i * innerSize, innerType))
+                    ptr = addrBase + i * innerSize
+                    self.putSubItem(i, lb_GetArrayNative(self, ptr, innerType))

     def putArrayItem(self, name, addr, n, typeName):
         self.checkIntType(addr)
@@ -2748,6 +2757,7 @@ class DumperBase:
             self.lbitsize = None
             self.targetValue = None # For references.
             self.isBaseClass = None
+            self.native = None

         def copy(self):
             val = self.dumper.Value(self.dumper)
@@ -2761,6 +2771,7 @@ class DumperBase:
             val.lbitpos = self.lbitpos
             val.lbitsize = self.lbitsize
             val.targetValue = self.targetValue
+            val.native = self.native
             return val

         def check(self):
@@ -2844,7 +2855,7 @@ class DumperBase:
             if self.type.code == TypeCodeTypedef:
                 return self.findMemberByName(self.detypedef())
             if self.type.code in (TypeCodePointer, TypeCodeReference):
-                res = self.dereference().findMemberByName(name)
+                res = lb_SetNative(self.dereference(), self.native.dereference()).findMemberByName(name)
                 if res is not None:
                     return res
             if self.type.code == TypeCodeStruct:
@@ -2892,7 +2903,7 @@ class DumperBase:
             elif self.dumper.isInt(index):
                 if self.type.code in (TypeCodeArray, TypeCodePointer):
                     itemAddress = self.laddress + int(index) * self.type.ltarget.size()
-                    return self.dumper.createValue(itemAddress, self.type.ltarget)
+                    return lb_SetNative(self.dumper.createValue(itemAddress, self.type.ltarget), self.native[index])
                 return self.members(False)[index]
             else:
                 error('BAD INDEX TYPE %s' % type(index))
@@ -2925,7 +2936,7 @@ class DumperBase:
                     val.laddress = self.laddress
                 if self.ldata is not None:
                     val.ldata = self.ldata
-                return val
+                return lb_SetNative(val, self.native)

             fieldBitsize = field.lbitsize
             fieldSize = (fieldBitsize + 7) // 8
@@ -2962,6 +2973,13 @@ class DumperBase:
                     val = self.dumper.createReferenceValue(val.laddress, fieldType.ltarget)
                     val.name = field.name

+            try:
+                self.native[field.name]
+            except:
+                val.native = self.native
+            else:
+                val.native = self.native[field.name]
+
             #warn('GOT VAL %s FOR FIELD %s' % (val, field))
             val.lbitsize = fieldBitsize
             val.check()
@@ -2990,7 +3008,7 @@ class DumperBase:
             anonNumber = 0
             for field in fields:
                 if isinstance(field, self.dumper.Value):
-                    res.append(field)
+                    res.append(lb_SetNative(field, self.native[field.name]))
                     continue
                 if field.isBaseClass and not includeBases:
                     continue
@@ -3019,7 +3037,7 @@ class DumperBase:
         def dereference(self):
             self.check()
             if self.type.code == TypeCodeTypedef:
-                return self.detypedef().dereference()
+                return lb_SetNative(self.detypedef().dereference(), self.native.dereference())
             val = self.dumper.Value(self.dumper)
             if self.type.code == TypeCodeReference:
                 val.laddress = self.pointer()
@@ -3036,7 +3054,7 @@ class DumperBase:
             #dynTypeName = val.type.dynamicTypeName(val.laddress)
             #if dynTypeName is not None:
             #    val.type = self.dumper.createType(dynTypeName)
-            return val
+            return lb_SetNative(val, self.native)

         def detypedef(self):
             self.check()
@@ -3073,7 +3091,7 @@ class DumperBase:
             val.lbitsize = self.lbitsize
             val.ldata = self.ldata
             val.type = self.dumper.createType(typish)
-            return val
+            return lb_SetNative(val, self.native.cast(self.d.lookupNativeType(typish.name)))

         def downcast(self):
             self.check()
diff --git a/gdbbridge.py b/gdbbridge.py
index f78b5fc..4a65a6b 100644
--- a/gdbbridge.py
+++ b/gdbbridge.py
@@ -223,6 +223,7 @@ class Dumper(DumperBase):
             targetType = self.fromNativeType(nativeType.target().unqualified(), nativeValue)
             val = self.createReferenceValue(toInteger(nativeValue.address), targetType)
             #warn('CREATED REF: %s' % val)
+            val.native = nativeValue
             return val
         if code == gdb.TYPE_CODE_PTR:
             try:
@@ -235,6 +236,7 @@ class Dumper(DumperBase):
             if not nativeValue.address is None:
                 val.laddress = toInteger(nativeValue.address)
             #warn('CREATED PTR 2: %s' % val)
+            val.native = nativeValue
             return val
         if code == gdb.TYPE_CODE_TYPEDEF:
             targetType = nativeType.strip_typedefs().unqualified()
@@ -247,6 +249,7 @@ class Dumper(DumperBase):
                 val = self.fromNativeValue(nativeValue.cast(targetType))
             val.type = self.fromNativeType(nativeType, nativeValue)
             #warn('CREATED TYPEDEF: %s' % val)
+            val.native = nativeValue
             return val

         val = self.Value(self)
@@ -261,6 +264,7 @@ class Dumper(DumperBase):
                 buf[i] = int(y[i])
             val.ldata = bytes(buf)

+        val.native = nativeValue
         val.type = self.fromNativeType(nativeType, nativeValue)
         val.lIsInScope = not nativeValue.is_optimized_out
         code = nativeType.code
diff --git a/stdtypes.py b/stdtypes.py
index 4b6308c..fbe89d4 100644
--- a/stdtypes.py
+++ b/stdtypes.py
@@ -701,15 +701,12 @@ def qdump__std____1__unique_ptr(d, value):


 def qdump__std__pair(d, value):
-    typeCode = '{%s}@{%s}' % (value.type[0].name, value.type[1].name)
-    first, pad, second = value.split(typeCode)
+    first, second = value["first"], value["second"]
+    first.native, second.native = value.native["first"], value.native["second"]
     with Children(d):
         key = d.putSubItem('first', first)
         value = d.putSubItem('second', second)
-    d.putField('key', key.value)
-    if key.encoding is not None:
-        d.putField('keyencoded', key.encoding)
-    d.putValue(value.value, value.encoding)
+    d.putType(first)

 def qform__std__unordered_map():
     return mapForms()
@@ -722,16 +719,19 @@ def qdump__std__unordered_map(d, value):
         # gcc ~= 4.7
         size = value["_M_element_count"].integer()
         start = value["_M_before_begin"]["_M_nxt"]
+        offset = 0
     except:
         try:
             # libc++ (Mac)
             size = value["_M_h"]["_M_element_count"].integer()
             start = value["_M_h"]["_M_bbegin"]["_M_node"]["_M_nxt"]
+            offset = 0
         except:
             try:
                 # gcc 4.9.1
                 size = value["_M_h"]["_M_element_count"].integer()
                 start = value["_M_h"]["_M_before_begin"]["_M_nxt"]
+                offset = 0
             except:
                 # gcc 4.6.2
                 size = value["_M_element_count"].integer()
@@ -740,18 +740,20 @@ def qdump__std__unordered_map(d, value):
                 d.putItemCount(size)
                 # We don't know where the data is
                 d.putNumChild(0)
+                offset = d.ptrSize()
                 return

     d.putItemCount(size)
     if d.isExpanded():
-        keyType = value.type[0]
-        valueType = value.type[1]
-        typeCode = 'p@{%s}@{%s}' % (value.type[0].name, value.type[1].name)
+        T = d.lookupNativeType(value.type.name + "::value_type")
+        T2 = d.fromNativeType(T)
+        ptrSize = d.ptrSize()
         p = start.pointer()
         with Children(d, size):
             for i in d.childRange():
-                p, pad, key, pad, val = d.split(typeCode, p)
-                d.putPairItem(i, (key, val))
+                ptr = p + ptrSize - offset
+                d.putSubItem(i, lb_GetArrayNative(d, ptr, T2))
+                p = d.extractPointer(p)

 def qdump__std____debug__unordered_map(d, value):
     qdump__std__unordered_map(d, value)
@@ -782,12 +784,14 @@ def qdump__std__unordered_set(d, value):

     d.putItemCount(size)
     if d.isExpanded():
+        T = d.lookupNativeType(value.type.name + "::value_type")
+        T2 = d.fromNativeType(T)
         p = start.pointer()
-        valueType = value.type[0]
-        with Children(d, size, childType=valueType):
+        with Children(d, size, childType=T2):
             ptrSize = d.ptrSize()
             for i in d.childRange():
-                d.putSubItem(i, d.createValue(p + ptrSize - offset, valueType))
+                ptr = p + ptrSize - offset
+                d.putSubItem(i, lb_GetArrayNative(d, ptr, T2))
                 p = d.extractPointer(p + offset)

 def qform__std____1__unordered_map():
@@ -881,7 +885,9 @@ def qdumpHelper__std__vector(d, value, isLibCpp):
             (start, soffset, pad, finish, foffset, pad, alloc) = value.split("pI@pI@p")
             size = (finish - start) * 8 + foffset - soffset # 8 is CHAR_BIT.
     else:
-        (start, finish, alloc) = value.split("ppp")
+        start = value["_M_start"].pointer()
+        finish = value["_M_finish"].pointer()
+        alloc = value["_M_end_of_storage"].pointer()
         size = int((finish - start) / innerType.size())
         d.check(finish <= alloc)
         if size > 0:
